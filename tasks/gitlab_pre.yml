---
- block: # Firewall Configuration for RedHat

  - name: Ensure firewalld is enabled
    ansible.builtin.systemd:
      name: firewalld
      state: started
      enabled: yes

  - name: Allow some firewall to using
    ansible.posix.firewalld:
      service: "{{ item }}"
      permanent: true
      state: enabled
      immediate: yes
    with_items: "{{ gitlab_firewalld_allows }}"

  when: ansible_os_family == "RedHat"


- name: Install GitLab dependencies
  ansible.builtin.package:
    name: "{{ gitlab_package_dependencies }}"
    state: present
    update_cache: yes #change from yes
  notify:
    - Start sshd

- name: Install Postfix
  ansible.builtin.package:
    name: postfix
    state: present
  notify:
    - Start postfix
  when: not gitlab_use_external_smtp

- name: Flush handlers
  ansible.builtin.meta: flush_handlers

- name: Run script to check system and add repository for GitLab CE
  ansible.builtin.shell: "curl -L -s {{ gitlab_script_url }} | bash"
  args:
    # Not to warn about using get_url
    warn: false
  tags:
    - molecule-idempotence-notest